<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Rubik's Cube Simulator</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: #f0f0f0;
        margin: 0;
        padding: 20px;
      }

      .main-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      .canvas-with-rotation {
        position: relative;
        display: flex;
        justify-content: center;
      }

      .canvas-container {
        display: flex;
        flex-direction: column;
        align-items: center;
      }

      #canvas {
        border: 1px solid #ccc;
        background-color: #000;
        cursor: grab;
      }

      #canvas:active {
        cursor: grabbing;
      }

      .controls {
        margin-top: 20px;
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        justify-content: center;
      }

      button {
        padding: 10px 15px;
        font-size: 16px;
        cursor: pointer;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 5px;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #45a049;
      }

      .face-buttons {
        display: flex;
        gap: 5px;
      }

      .face-buttons button {
        background-color: #2196f3;
      }

      .face-buttons button:hover {
        background-color: #0b7dda;
      }

      .reorientation-buttons button {
        background-color: #9c27b0;
      }

      .reorientation-buttons button:hover {
        background-color: #7b1fa2;
      }

      .reorientation-buttons {
        display: flex;
        gap: 5px;
      }

      .slice-buttons {
        display: flex;
        gap: 5px;
      }

      .slice-buttons button {
        background-color: #ff5722;
        font-size: 14px;
        min-width: 50px;
      }

      .slice-buttons button:hover {
        background-color: #e64a19;
      }

      .double-buttons {
        display: flex;
        gap: 5px;
      }

      .double-buttons button {
        background-color: #795548;
        font-size: 14px;
        min-width: 50px;
      }

      .double-buttons button:hover {
        background-color: #5d4037;
      }

      .rotation-controls {
        position: absolute;
        right: -90px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
      }

      .speed-controls {
        position: absolute;
        left: -90px;
        top: 50%;
        transform: translateY(-50%);
        display: flex;
        flex-direction: column;
        gap: 10px;
        align-items: center;
        font-size: 14px;
        color: #333;
      }

      .speed-controls label {
        display: flex;
        align-items: center;
        gap: 5px;
        cursor: pointer;
        padding: 5px;
        border-radius: 5px;
        transition: background-color 0.3s;
      }

      .speed-controls label:hover {
        background-color: rgba(255, 152, 0, 0.1);
      }

      .speed-controls input[type="radio"] {
        margin: 0;
      }

      .rotation-button {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        background-color: #ff9800;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: background-color 0.3s;
        user-select: none;
      }

      .rotation-button:hover {
        background-color: #e68900;
      }

      .rotation-button:active {
        background-color: #cc7a00;
      }

      .rotation-button svg {
        width: 30px;
        height: 30px;
        fill: white;
      }

      #reset-orientation-btn {
        background-color: #9c27b0;
      }

      #reset-orientation-btn:hover {
        background-color: #7b1fa2;
      }

      #reset-orientation-btn:active {
        background-color: #6a1b9a;
      }

      .sequence-input {
        display: flex;
        gap: 10px;
        align-items: center;
        justify-content: center;
        flex-wrap: wrap;
      }

      #move-sequence {
        padding: 8px 12px;
        font-size: 14px;
        border: 2px solid #ccc;
        border-radius: 5px;
        width: 400px;
        font-family: 'Courier New', monospace;
        background-color: white;
        transition: border-color 0.3s;
      }

      #move-sequence:focus {
        outline: none;
        border-color: #4caf50;
      }

      .sequence-input button {
        padding: 8px 16px;
        font-size: 14px;
      }

      .error-dialog {
        border: none;
        border-radius: 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        padding: 20px;
        max-width: 400px;
        text-align: center;
      }

      .error-dialog::backdrop {
        background-color: rgba(0, 0, 0, 0.5);
      }

      .error-dialog h3 {
        color: #e53e3e;
        margin-top: 0;
      }

      .error-dialog button {
        background-color: #e53e3e;
        color: white;
        border: none;
        padding: 8px 16px;
        border-radius: 5px;
        cursor: pointer;
        margin-top: 10px;
      }

      .error-dialog button:hover {
        background-color: #c53030;
      }
    </style>
  </head>
  <body>
    <h1>Rubik's Cube Simulator</h1>

    <div class="main-container">
      <div class="canvas-container">
        <div class="canvas-with-rotation">
          <canvas id="canvas" width="600" height="600"></canvas>

          <div class="speed-controls">
            <label>
              <input type="radio" name="animation-speed" value="fast">
              Fast
            </label>
            <label>
              <input type="radio" name="animation-speed" value="slow" checked>
              Slow
            </label>
          </div>

          <div class="rotation-controls">
            <button class="rotation-button" id="counterclockwise-btn" title="Hold to rotate cube counterclockwise">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 6V9l4-4-4-4v3c-4.42 0-8 3.58-8 8 0 1.57.46 3.03 1.24 4.26L6.7 14.8c-.45-.83-.7-1.79-.7-2.8 0-3.31 2.69-6 6-6z"
                  fill="white"
                />
              </svg>
            </button>
            <button class="rotation-button" id="clockwise-btn" title="Hold to rotate cube clockwise">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 6V9l-4-4 4-4v3c4.42 0 8 3.58 8 8 0 1.57-.46 3.03-1.24 4.26L17.3 14.8c.45-.83.7-1.79.7-2.8 0-3.31-2.69-6-6-6z"
                  fill="white"
                />
              </svg>
            </button>
            <button class="rotation-button" id="reset-orientation-btn" title="Reset cube orientation to default view">
              <svg viewBox="0 0 24 24">
                <path
                  d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 17.93c-3.94-.49-7-3.85-7-7.93 0-.62.08-1.21.21-1.79L9 15v1c0 1.1.9 2 2 2v1.93zm6.9-2.54c-.26-.81-1-1.39-1.9-1.39h-1v-3c0-.55-.45-1-1-1H8v-2h2c.55 0 1-.45 1-1V7h2c1.1 0 2-.9 2-2v-.41c2.93 1.19 5 4.06 5 7.41 0 2.08-.8 3.97-2.1 5.39z"
                  fill="white"
                />
              </svg>
            </button>
          </div>
        </div>

        <div class="controls">
          <div class="face-buttons">
            <button onclick="renderer.animateMove('U')">U</button>
            <button onclick="renderer.animateMove('U\'')">U'</button>
            <button onclick="renderer.animateMove('D')">D</button>
            <button onclick="renderer.animateMove('D\'')">D'</button>
            <button onclick="renderer.animateMove('R')">R</button>
            <button onclick="renderer.animateMove('R\'')">R'</button>
            <button onclick="renderer.animateMove('L')">L</button>
            <button onclick="renderer.animateMove('L\'')">L'</button>
            <button onclick="renderer.animateMove('F')">F</button>
            <button onclick="renderer.animateMove('F\'')">F'</button>
            <button onclick="renderer.animateMove('B')">B</button>
            <button onclick="renderer.animateMove('B\'')">B'</button>
          </div>
        </div>

        <div class="controls">
          <div class="reorientation-buttons">
            <button onclick="renderer.animateMove('x')">x</button>
            <button onclick="renderer.animateMove('x\'')">x'</button>
            <button onclick="renderer.animateMove('y')">y</button>
            <button onclick="renderer.animateMove('y\'')">y'</button>
            <button onclick="renderer.animateMove('z')">z</button>
            <button onclick="renderer.animateMove('z\'')">z'</button>
          </div>
        </div>

        <div class="controls">
          <div class="slice-buttons">
            <button onclick="renderer.animateMove('M')">M</button>
            <button onclick="renderer.animateMove('M\'')">M'</button>
            <button onclick="renderer.animateMove('E')">E</button>
            <button onclick="renderer.animateMove('E\'')">E'</button>
            <button onclick="renderer.animateMove('S')">S</button>
            <button onclick="renderer.animateMove('S\'')">S'</button>
          </div>
        </div>

        <div class="controls">
          <div class="double-buttons">
            <button onclick="renderer.animateMove('r')">r</button>
            <button onclick="renderer.animateMove('r\'')">r'</button>
            <button onclick="renderer.animateMove('l')">l</button>
            <button onclick="renderer.animateMove('l\'')">l'</button>
            <button onclick="renderer.animateMove('u')">u</button>
            <button onclick="renderer.animateMove('u\'')">u'</button>
            <button onclick="renderer.animateMove('d')">d</button>
            <button onclick="renderer.animateMove('d\'')">d'</button>
            <button onclick="renderer.animateMove('f')">f</button>
            <button onclick="renderer.animateMove('f\'')">f'</button>
            <button onclick="renderer.animateMove('b')">b</button>
            <button onclick="renderer.animateMove('b\'')">b'</button>
          </div>
        </div>

        <div class="controls">
          <div class="sequence-input">
            <input type="text" id="move-sequence" placeholder="Enter moves: R U R' U' R' F R2 U' R' U' R U R' F'" />
            <button id="execute-move-sequence">Execute</button>
          </div>
        </div>

        <div class="controls">
          <button id="scramble">Scramble</button>
          <button id="reset">Reset</button>
        </div>
      </div>
    </div>

    <dialog id="error-dialog" class="error-dialog">
      <h3>Invalid Move Sequence</h3>
      <p id="error-message"></p>
      <button id="hide-error-modal">OK</button>
    </dialog>

    <script type="module">
      import { RubiksCube } from './cube.js';
      import { CubeRenderer } from './renderer.js';
      import { quat_fromAxisAngle, quat_multiply, quat_normalize } from './3d-math.js';

      const canvas = document.getElementById('canvas');
      window.cube = new RubiksCube();
      window.renderer = new CubeRenderer(canvas, cube);

      // This tries to be clever for the rendering. If doing statistics, be dumb instead.
      function scrambleCube() {
        const moves = ['U', "U'", 'D', "D'", 'R', "R'", 'L', "L'", 'F', "F'", 'B', "B'"];
        const scrambleLength = 30 + Math.floor(Math.random() * 11);

        const getBaseFace = move => move.replace("'", '');

        const getInverse = move => (move.includes("'") ? move.replace("'", '') : move + "'");

        const areOppositeFaces = (face1, face2) => {
          const opposites = { U: 'D', D: 'U', R: 'L', L: 'R', F: 'B', B: 'F' };
          return opposites[face1] === face2;
        };

        const scramble = [];

        for (let i = 0; i < scrambleLength; i++) {
          let validMoves = [...moves];

          if (scramble.length > 0) {
            const lastMove = scramble[scramble.length - 1];
            const lastBaseFace = getBaseFace(lastMove);

            const lastInverse = getInverse(lastMove);
            validMoves = validMoves.filter(move => move !== lastInverse);

            if (scramble.length > 1) {
              const secondLastMove = scramble[scramble.length - 2];
              const secondLastBaseFace = getBaseFace(secondLastMove);

              if (lastBaseFace === secondLastBaseFace) {
                // Already have 2 consecutive moves on same face, don't allow a third
                validMoves = validMoves.filter(move => getBaseFace(move) !== lastBaseFace);
              }

              // Check for opposite face sandwich patterns
              // Case 1: U D U' - second-to-last and last are opposite faces
              if (areOppositeFaces(secondLastBaseFace, lastBaseFace)) {
                const secondLastInverse = getInverse(secondLastMove);
                validMoves = validMoves.filter(move => move !== secondLastInverse);
              }

              // Case 2: U D D U' - need to look back one more step
              if (scramble.length > 2) {
                const thirdLastMove = scramble[scramble.length - 3];
                const thirdLastBaseFace = getBaseFace(thirdLastMove);

                // If last two moves are same face and opposite to third-to-last, avoid third-to-last inverse
                if (lastBaseFace === secondLastBaseFace && areOppositeFaces(thirdLastBaseFace, lastBaseFace)) {
                  const thirdLastInverse = getInverse(thirdLastMove);
                  validMoves = validMoves.filter(move => move !== thirdLastInverse);
                }
              }
            }
          }

          const randomMove = validMoves[Math.floor(Math.random() * validMoves.length)];
          scramble.push(randomMove);
          renderer.animateSimpleMove(randomMove);
        }
      }

      function resetCube() {
        cube.reset();
        renderer.reset();
      }

      function resetOrientation() {
        renderer.orientation = [0.14000166646724985, 0.14000166646724985, 0, 0.9802035843501011];
        renderer.render();
      }

      function parseMoveSequence(sequence) {
        const cleanSequence = sequence.replace(/\s|\(|\)/g, '').replace(/[XYZ]/g, m => m.toLowerCase());
        const moves = [];
        const invalidChars = [];

        let i = 0;
        while (i < cleanSequence.length) {
          const char = cleanSequence[i];

          if (/[UDRLFBxyzMESrludfb]/.test(char)) {
            let move = char;

            // Check for prime or 2
            if (i + 1 < cleanSequence.length) {
              if (cleanSequence[i + 1] === "'") {
                move += "'";
                i++;
              } else if (cleanSequence[i + 1] === '2') {
                moves.push(move, move);
                i += 2;
                continue;
              }
            }

            moves.push(move);
          } else if (!invalidChars.includes(char)) {
            invalidChars.push(char);
          }
          i++;
        }

        return { moves, invalidChars };
      }

      function showErrorModal(message) {
        const dialog = document.getElementById('error-dialog');
        const messageElement = document.getElementById('error-message');
        messageElement.innerHTML = message;
        dialog.showModal();
      }

      function hideErrorModal() {
        const dialog = document.getElementById('error-dialog');
        dialog.close();
      }

      function executeMoveSequence() {
        const input = document.getElementById('move-sequence');
        const sequence = input.value.trim();

        if (!sequence) return;

        const result = parseMoveSequence(sequence);

        if (result.invalidChars.length > 0) {
          const invalidStr = result.invalidChars.map(c => `'${c}'`).join(', ');
          showErrorModal(
            `Unrecognized characters: ${invalidStr}<br><br>Valid characters are: U, D, R, L, F, B, x, y, z, M, E, S, r, l, u, d, f, b, ', 2`,
          );
          return;
        }

        for (const move of result.moves) {
          renderer.animateMove(move);
        }
      }

      let isDragging = false;
      let lastX, lastY;

      canvas.addEventListener('mousedown', e => {
        isDragging = true;
        lastX = e.clientX;
        lastY = e.clientY;
      });

      const rotationSpeed = 0.008;

      window.addEventListener('mousemove', e => {
        if (!isDragging) return;

        const deltaX = e.clientX - lastX;
        const deltaY = e.clientY - lastY;

        // Create rotation quaternions
        const rotY = quat_fromAxisAngle([0, 1, 0], -deltaX * rotationSpeed);
        const rotX = quat_fromAxisAngle([1, 0, 0], deltaY * rotationSpeed);

        const deltaQuat = quat_multiply(rotY, rotX);
        renderer.orientation = quat_normalize(quat_multiply(deltaQuat, renderer.orientation));

        lastX = e.clientX;
        lastY = e.clientY;

        renderer.render();
      });

      window.addEventListener('mouseup', () => {
        isDragging = false;
      });

      let isRotatingZ = false;
      let rotationDirection = 0; // 1 for clockwise, -1 for counterclockwise

      function rotateZ(direction) {
        const rotationSpeed = 0.02;
        const zRotation = quat_fromAxisAngle([0, 0, 1], direction * rotationSpeed);
        renderer.orientation = quat_normalize(quat_multiply(zRotation, renderer.orientation));
        renderer.render();
      }

      function startZRotation(direction) {
        if (isRotatingZ) return;
        isRotatingZ = true;
        rotationDirection = direction;

        function animate() {
          if (isRotatingZ) {
            rotateZ(rotationDirection);
            requestAnimationFrame(animate);
          }
        }
        animate();
      }

      function stopZRotation() {
        isRotatingZ = false;
      }

      const clockwiseBtn = document.getElementById('clockwise-btn');
      const counterclockwiseBtn = document.getElementById('counterclockwise-btn');

      clockwiseBtn.addEventListener('mousedown', e => {
        e.preventDefault();
        startZRotation(-1);
      });

      clockwiseBtn.addEventListener('mouseup', e => {
        e.preventDefault();
        stopZRotation();
      });

      clockwiseBtn.addEventListener('mouseleave', e => {
        stopZRotation();
      });

      counterclockwiseBtn.addEventListener('mousedown', e => {
        e.preventDefault();
        startZRotation(1);
      });

      counterclockwiseBtn.addEventListener('mouseup', e => {
        e.preventDefault();
        stopZRotation();
      });

      counterclockwiseBtn.addEventListener('mouseleave', e => {
        stopZRotation();
      });

      document.addEventListener('mouseup', () => {
        stopZRotation();
      });

      document.getElementById('reset-orientation-btn').addEventListener('click', resetOrientation);

      document.getElementById('scramble').addEventListener('click', scrambleCube);

      document.getElementById('reset').addEventListener('click', resetCube);

      document.getElementById('move-sequence').addEventListener('keypress', e => {
        if (e.key === 'Enter') {
          executeMoveSequence();
        }
      });

      document.getElementById('execute-move-sequence').addEventListener('click', executeMoveSequence);

      document.getElementById('hide-error-modal').addEventListener('click', hideErrorModal);

      document.querySelectorAll('input[name="animation-speed"]').forEach(radio => {
        radio.addEventListener('change', (e) => {
          if (e.target.value === 'fast') {
            renderer.animationDuration = 100;
          } else if (e.target.value === 'slow') {
            renderer.animationDuration = 600;
          }
        });
      });

      document.addEventListener('keydown', e => {
        if (e.metaKey || e.ctrlKey || e.altKey) return;

        const activeElement = document.activeElement;
        if (activeElement && (
          activeElement.tagName === 'INPUT' ||
          activeElement.tagName === 'TEXTAREA' ||
          activeElement.contentEditable === 'true'
        )) {
          return;
        }

        let { key } = e;
        key = key.toLowerCase();

        if (!'udrlbfmesxyz'.includes(key)) return;
        e.preventDefault();

        if ('udrlbfmes'.includes(key)) key = key.toUpperCase();

        if (e.shiftKey) key += "'";

        renderer.animateMove(key);
      });
    </script>
  </body>
</html>
